{% extends "base.html" %}

{% block title %}Class Scheduling & Timetable{% endblock %}

{% block extra_css %}
<style>
    /* Override base layout for full calendar view */
    .main-content {
        margin-left: var(--sidebar-width) !important;
        width: calc(100% - var(--sidebar-width)) !important;
        padding: 0 !important;
        background: #f8fafc;
        min-height: 100vh;
    }

    @media (max-width: 1024px) {
        .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }
    }

    /* Calendar specific styles */
    .calendar-header {
        background: white;
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .view-toggle {
        background: #f1f5f9;
        border-radius: 0.5rem;
        padding: 0.25rem;
        display: flex;
        gap: 0.25rem;
    }

    .view-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        border-radius: 0.375rem;
        border: none;
        background: transparent;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
    }

    .view-btn.active {
        background: var(--primary-color);
        color: white;
    }

    .calendar-layout {
        display: flex;
        height: calc(100vh - 64px);
    }

    .sidebar-panel {
        width: 320px;
        background: white;
        border-right: 1px solid #e2e8f0;
        overflow-y: auto;
    }

    .calendar-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .calendar-grid {
        flex: 1;
        overflow: auto;
    }

    .time-column {
        width: 80px;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
    }

    .day-columns {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(7, 1fr);
    }

    .day-header {
        height: 60px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
        font-weight: 600;
    }

    .day-header.today {
        background: rgba(241, 161, 80, 0.1);
        color: var(--primary-color);
    }

    .time-slot {
        height: 60px;
        border-bottom: 1px solid #f1f5f9;
        border-right: 1px solid #f1f5f9;
        position: relative;
        cursor: pointer;
    }

    .time-slot:hover {
        background: rgba(241, 161, 80, 0.05);
    }

    .time-label {
        position: absolute;
        top: 8px;
        left: 8px;
        font-size: 0.75rem;
        color: #64748b;
    }

    .class-block {
        position: absolute;
        left: 4px;
        right: 4px;
        border-radius: 6px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .class-block:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .class-block.primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, #e8974a 100%);
        color: white;
    }

    .class-block.secondary {
        background: linear-gradient(135deg, var(--secondary-color) 0%, #5a6268 100%);
        color: white;
    }

    .class-block.success {
        background: linear-gradient(135deg, var(--success-color) 0%, #1e7e34 100%);
        color: white;
    }

    .class-title {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 2px;
    }

    .class-details {
        font-size: 0.625rem;
        opacity: 0.9;
    }

    .panel-section {
        padding: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .stat-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem;
        background: #f8fafc;
        border-radius: 0.375rem;
    }

    .stat-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #64748b;
    }

    .stat-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.scheduled { background: var(--primary-color); }
    .status-dot.ongoing { background: var(--warning-color); }
    .status-dot.completed { background: var(--success-color); }
    .status-dot.cancelled { background: var(--danger-color); }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .modal-content {
        background: white;
        border-radius: 0.75rem;
        padding: 2rem;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .form-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(241, 161, 80, 0.1);
    }

    .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: #e8974a;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #f8fafc;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
        background: #f1f5f9;
    }

    .loading {
        pointer-events: none;
        opacity: 0.7;
    }

    .loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 1100;
        animation: slideInRight 0.3s ease-out;
    }

    .alert.success { background: var(--success-color); }
    .alert.error { background: var(--danger-color); }
    .alert.warning { background: var(--warning-color); }
    .alert.info { background: var(--info-color); }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Calendar Header -->
<div class="calendar-header">
    <div class="flex items-center gap-4">
        <h1 class="text-2xl font-bold text-gray-900" id="currentMonth">December 2024</h1>
        <div class="flex items-center gap-2">
            <button class="btn btn-secondary" id="prevWeek">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="btn btn-secondary" id="nextWeek">
                <i class="fas fa-chevron-right"></i>
            </button>
            <button class="btn btn-secondary" id="todayBtn">Today</button>
        </div>
    </div>

    <div class="flex items-center gap-4">
        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" data-view="week">Weekly</button>
            <button class="view-btn" data-view="month">Monthly</button>
            <button class="view-btn" data-view="today">Daily</button>
        </div>

        <!-- Filter -->
        <select class="form-input" id="filterSelect" style="width: 200px;">
            <option value="all">All Classes</option>
            {% for dept in departments %}
            <option value="department-{{ dept.id }}">{{ dept.name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Calendar Layout -->
<div class="calendar-layout">
    <!-- Left Sidebar Panel -->
    <div class="sidebar-panel">
        <!-- Quick Actions -->
        <div class="panel-section">
            <div class="section-title">Quick Actions</div>
            <button class="btn btn-primary w-full mb-2" onclick="openQuickClassModal()">
                <i class="fas fa-plus"></i>
                Create New Class
            </button>
            <button class="btn btn-secondary w-full">
                <i class="fas fa-users"></i>
                Create Group Class
            </button>
        </div>

        <!-- Today's Statistics -->
        <div class="panel-section">
            <div class="section-title">Today's Status</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">
                        <div class="status-dot scheduled"></div>
                        Scheduled
                    </div>
                    <div class="stat-value" id="scheduledCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">
                        <div class="status-dot ongoing"></div>
                        Ongoing
                    </div>
                    <div class="stat-value" id="ongoingCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">
                        <div class="status-dot completed"></div>
                        Completed
                    </div>
                    <div class="stat-value" id="completedCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">
                        <div class="status-dot cancelled"></div>
                        Cancelled
                    </div>
                    <div class="stat-value" id="cancelledCount">0</div>
                </div>
            </div>
        </div>

        <!-- Available Tutors -->
        <div class="panel-section">
            <div class="section-title">Available Tutors</div>
            <div id="availableTutors" class="space-y-2">
                <!-- Dynamically loaded -->
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="panel-section">
            <div class="section-title">Recent Activities</div>
            <div id="recentActivities" class="space-y-2">
                <!-- Dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- Calendar Main Area -->
    <div class="calendar-main">
        <!-- Weekly View -->
        <div id="weeklyView" class="calendar-grid">
            <div class="flex">
                <!-- Time Column -->
                <div class="time-column">
                    <div class="day-header"></div>
                    <div id="timeSlots"></div>
                </div>

                <!-- Day Columns -->
                <div class="day-columns">
                    <!-- Day Headers -->
                    <div class="day-header" data-day="0">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">MON</div>
                            <div class="text-sm font-medium" id="day-0">16</div>
                        </div>
                    </div>
                    <div class="day-header" data-day="1">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">TUE</div>
                            <div class="text-sm font-medium" id="day-1">17</div>
                        </div>
                    </div>
                    <div class="day-header today" data-day="2">
                        <div class="text-center">
                            <div class="text-xs">WED</div>
                            <div class="text-sm font-medium" id="day-2">18</div>
                        </div>
                    </div>
                    <div class="day-header" data-day="3">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">THU</div>
                            <div class="text-sm font-medium" id="day-3">19</div>
                        </div>
                    </div>
                    <div class="day-header" data-day="4">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">FRI</div>
                            <div class="text-sm font-medium" id="day-4">20</div>
                        </div>
                    </div>
                    <div class="day-header" data-day="5">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">SAT</div>
                            <div class="text-sm font-medium" id="day-5">21</div>
                        </div>
                    </div>
                    <div class="day-header" data-day="6">
                        <div class="text-center">
                            <div class="text-xs text-gray-500">SUN</div>
                            <div class="text-sm font-medium" id="day-6">22</div>
                        </div>
                    </div>

                    <!-- Calendar Grid Content -->
                    <div id="calendarGrid"></div>
                </div>
            </div>
        </div>

        <!-- Monthly View (Initially Hidden) -->
        <div id="monthlyView" class="calendar-grid" style="display: none;">
            <div id="monthGrid" class="p-4">
                <!-- Monthly calendar will be generated here -->
            </div>
        </div>

        <!-- Daily View (Initially Hidden) -->
        <div id="dailyView" class="calendar-grid" style="display: none;">
            <div id="dailyClasses" class="p-4">
                <!-- Daily classes will be listed here -->
            </div>
        </div>
    </div>
</div>

<!-- Quick Class Creation Modal -->
<div id="quickClassModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-900">Create New Class</h2>
            <button onclick="closeQuickClassModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="quickClassForm" class="space-y-4">
            <!-- Class Type -->
            <div class="form-group">
                <label class="form-label">Class Type</label>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="class_type" value="one_on_one" class="mr-3" checked />
                        <div>
                            <div class="font-medium text-gray-900">One-on-One</div>
                            <div class="text-sm text-gray-600">Individual tutoring</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="class_type" value="group" class="mr-3" />
                        <div>
                            <div class="font-medium text-gray-900">Group Class</div>
                            <div class="text-sm text-gray-600">Multiple students</div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="form-grid">
                <!-- Tutor Selection -->
                <div class="form-group">
                    <label class="form-label">Select Tutor</label>
                    <select name="tutor_id" class="form-input" required>
                        <option value="">Choose a tutor...</option>
                        {% for tutor in tutors %}
                        <option value="{{ tutor.id }}">{{ tutor.user.full_name }} - {{ tutor.subjects }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Student Selection -->
                <div class="form-group">
                    <label class="form-label">Select Student</label>
                    <select name="student_id" class="form-input" required>
                        <option value="">Choose a student...</option>
                        {% for student in students %}
                        <option value="{{ student.id }}">{{ student.full_name }} - Grade {{ student.grade }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <!-- Subject -->
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <input type="text" name="subject" class="form-input" placeholder="Enter subject" required />
                </div>

                <!-- Duration -->
                <div class="form-group">
                    <label class="form-label">Duration (minutes)</label>
                    <select name="duration" class="form-input" required>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>
            </div>

            <div class="form-grid">
                <!-- Date -->
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" name="scheduled_date" class="form-input" required />
                </div>

                <!-- Time -->
                <div class="form-group">
                    <label class="form-label">Time</label>
                    <input type="time" name="scheduled_time" class="form-input" required />
                </div>
            </div>

            <!-- Notes -->
            <div class="form-group">
                <label class="form-label">Notes (Optional)</label>
                <textarea name="notes" class="form-input" rows="3" placeholder="Additional notes..."></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4 pt-4">
                <button type="button" onclick="closeQuickClassModal()" class="btn btn-secondary">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Create Class
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Class Details Modal -->
<div id="classDetailsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-900">Class Details</h2>
            <button onclick="closeClassDetailsModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div id="classDetailsContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<script>
// Global variables
let currentDate = new Date();
let currentView = 'week';
let classesData = [];

// Initialize the calendar
document.addEventListener('DOMContentLoaded', function() {
    initializeCalendar();
    loadTimetableData();
    setupEventListeners();
});

// Initialize calendar
function initializeCalendar() {
    generateTimeSlots();
    generateCalendarGrid();
    updateDateDisplay();
}

// Generate time slots (9 AM to 6 PM)
function generateTimeSlots() {
    const container = document.getElementById('timeSlots');
    const times = [];
    
    for (let hour = 9; hour <= 18; hour++) {
        const time12 = hour > 12 ? `${hour - 12}:00 PM` : `${hour}:00 AM`;
        times.push(`<div class="time-slot"><div class="time-label">${time12}</div></div>`);
    }
    
    container.innerHTML = times.join('');
}

// Generate calendar grid for weekly view
function generateCalendarGrid() {
    const container = document.getElementById('calendarGrid');
    const rows = 10; // 9 AM to 6 PM
    const cols = 7; // Days of week
    
    let grid = '';
    for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
            grid += `<div class="time-slot" data-day="${col}" data-hour="${row + 9}" onclick="handleTimeSlotClick(${col}, ${row + 9})"></div>`;
        }
    }
    
    container.innerHTML = grid;
    container.style.display = 'grid';
    container.style.gridTemplateColumns = 'repeat(7, 1fr)';
    container.style.gridTemplateRows = 'repeat(10, 60px)';
}

// Load timetable data from API
async function loadTimetableData() {
    try {
        showLoading(true);
        
        const endpoint = currentView === 'today' ? '/api/v1/timetable/today' : 
                        currentView === 'month' ? '/api/v1/timetable/month' : 
                        '/api/v1/timetable/week';
        
        const params = new URLSearchParams({
            date: currentDate.toISOString().split('T')[0],
            filter_type: 'all',
            filter_value: ''
        });
        
        const response = await fetch(`${endpoint}?${params}`);
        const data = await response.json();
        
        if (data.success) {
            classesData = data.classes || [];
            updateStats(data.stats || {});
            renderClasses();
        } else {
            showAlert('Error loading timetable data', 'error');
        }
    } catch (error) {
        console.error('Error loading timetable:', error);
        showAlert('Failed to load timetable data', 'error');
    } finally {
        showLoading(false);
    }
}

// Render classes on calendar
function renderClasses() {
    // Clear existing classes
    document.querySelectorAll('.class-block').forEach(el => el.remove());
    
    if (currentView === 'week') {
        renderWeeklyClasses();
    } else if (currentView === 'today') {
        renderDailyClasses();
    } else if (currentView === 'month') {
        renderMonthlyClasses();
    }
}

// Render classes for weekly view
function renderWeeklyClasses() {
    classesData.forEach(cls => {
        const classDate = new Date(cls.scheduled_date);
        const dayOfWeek = classDate.getDay();
        const hour = parseInt(cls.scheduled_time.split(':')[0]);
        
        // Find the corresponding time slot
        const timeSlot = document.querySelector(`[data-day="${dayOfWeek}"][data-hour="${hour}"]`);
        if (timeSlot) {
            const classBlock = createClassBlock(cls);
            timeSlot.appendChild(classBlock);
        }
    });
}

// Create class block element
function createClassBlock(cls) {
    const block = document.createElement('div');
    block.className = `class-block ${getStatusClass(cls.status)}`;
    block.dataset.classId = cls.id;
    block.onclick = () => openClassDetails(cls.id);
    
    block.innerHTML = `
        <div class="class-title">${cls.subject}</div>
        <div class="class-details">${cls.tutor_name}</div>
        <div class="class-details">${cls.student_name}</div>
        <div class="class-details">${cls.scheduled_time}</div>
    `;
    
    return block;
}

// Get status class for styling
function getStatusClass(status) {
    const statusMap = {
        'scheduled': 'primary',
        'ongoing': 'secondary',
        'completed': 'success',
        'cancelled': 'danger'
    };
    return statusMap[status] || 'primary';
}

// Update statistics display
function updateStats(stats) {
    document.getElementById('scheduledCount').textContent = stats.scheduled || 0;
    document.getElementById('ongoingCount').textContent = stats.ongoing || 0;
    document.getElementById('completedCount').textContent = stats.completed || 0;
    document.getElementById('cancelledCount').textContent = stats.cancelled || 0;
}

// Setup event listeners
function setupEventListeners() {
    // View toggle buttons
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switchView(this.dataset.view);
        });
    });
    
    // Navigation buttons
    document.getElementById('prevWeek').addEventListener('click', () => navigateWeek(-1));
    document.getElementById('nextWeek').addEventListener('click', () => navigateWeek(1));
    document.getElementById('todayBtn').addEventListener('click', () => goToToday());
    
    // Filter select
    document.getElementById('filterSelect').addEventListener('change', function() {
        applyFilter(this.value);
    });
    
    // Quick class form
    document.getElementById('quickClassForm').addEventListener('submit', handleQuickClassSubmit);
}

// Switch calendar view
function switchView(view) {
    currentView = view;
    
    // Update button states
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
    });
    
    // Show/hide views
    document.getElementById('weeklyView').style.display = view === 'week' ? 'block' : 'none';
    document.getElementById('monthlyView').style.display = view === 'month' ? 'block' : 'none';
    document.getElementById('dailyView').style.display = view === 'today' ? 'block' : 'none';
    
    loadTimetableData();
}

// Navigate weeks
function navigateWeek(direction) {
    const days = direction * 7;
    currentDate.setDate(currentDate.getDate() + days);
    updateDateDisplay();
    loadTimetableData();
}

// Go to today
function goToToday() {
    currentDate = new Date();
    updateDateDisplay();
    loadTimetableData();
}

// Update date display
function updateDateDisplay() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    
    // Update day headers for weekly view
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
    
    for (let i = 0; i < 7; i++) {
        const day = new Date(startOfWeek);
        day.setDate(startOfWeek.getDate() + i);
        document.getElementById(`day-${i}`).textContent = day.getDate();
        
        // Mark today
        const header = document.querySelector(`[data-day="${i}"]`);
        const isToday = day.toDateString() === new Date().toDateString();
        header.classList.toggle('today', isToday);
    }
}

// Handle time slot clicks
function handleTimeSlotClick(day, hour) {
    const selectedDate = new Date(currentDate);
    selectedDate.setDate(currentDate.getDate() - currentDate.getDay() + day);
    
    // Pre-fill quick class modal with selected time
    document.querySelector('[name="scheduled_date"]').value = selectedDate.toISOString().split('T')[0];
    document.querySelector('[name="scheduled_time"]').value = `${hour.toString().padStart(2, '0')}:00`;
    
    openQuickClassModal();
}

// Modal functions
function openQuickClassModal() {
    document.getElementById('quickClassModal').style.display = 'flex';
    // Set default date to today if not set
    const dateInput = document.querySelector('[name="scheduled_date"]');
    if (!dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
}

function closeQuickClassModal() {
    document.getElementById('quickClassModal').style.display = 'none';
    document.getElementById('quickClassForm').reset();
}

function openClassDetails(classId) {
    document.getElementById('classDetailsModal').style.display = 'flex';
    loadClassDetails(classId);
}

function closeClassDetailsModal() {
    document.getElementById('classDetailsModal').style.display = 'none';
}

// Load class details
async function loadClassDetails(classId) {
    try {
        const response = await fetch(`/api/v1/classes/${classId}`);
        const data = await response.json();
        
        if (data.success) {
            const cls = data.data;
            document.getElementById('classDetailsContent').innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-blue-800 mb-2">${cls.subject}</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tutor:</span>
                            <span class="font-medium">${cls.tutor_name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Student:</span>
                            <span class="font-medium">${cls.student_name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Time:</span>
                            <span class="font-medium">${cls.scheduled_time} - ${cls.end_time}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="font-medium capitalize">${cls.status}</span>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button class="btn btn-primary">
                        <i class="fas fa-video"></i>
                        Join Class
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-edit"></i>
                        Edit Class
                    </button>
                </div>
                
                <div class="space-y-2">
                    <button class="w-full text-left p-2 text-sm text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                        <i class="fas fa-bell mr-2"></i>
                        Send Reminder
                    </button>
                    <button class="w-full text-left p-2 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors" onclick="cancelClass(${classId})">
                        <i class="fas fa-times mr-2"></i>
                        Cancel Class
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading class details:', error);
        showAlert('Failed to load class details', 'error');
    }
}

// Handle quick class form submission
async function handleQuickClassSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    try {
        showLoading(true);
        
        const response = await fetch('/api/v1/timetable/temp-class', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Class created successfully!', 'success');
            closeQuickClassModal();
            loadTimetableData(); // Refresh the calendar
        } else {
            showAlert(result.error || 'Failed to create class', 'error');
        }
    } catch (error) {
        console.error('Error creating class:', error);
        showAlert('Failed to create class', 'error');
    } finally {
        showLoading(false);
    }
}

// Cancel class
async function cancelClass(classId) {
    if (!confirm('Are you sure you want to cancel this class?')) return;
    
    try {
        const response = await fetch(`/api/v1/classes/${classId}/cancel`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Class cancelled successfully', 'success');
            closeClassDetailsModal();
            loadTimetableData();
        } else {
            showAlert(result.error || 'Failed to cancel class', 'error');
        }
    } catch (error) {
        console.error('Error cancelling class:', error);
        showAlert('Failed to cancel class', 'error');
    }
}

// Utility functions
function showLoading(show) {
    const elements = document.querySelectorAll('.btn');
    elements.forEach(el => {
        if (show) {
            el.classList.add('loading');
            el.disabled = true;
        } else {
            el.classList.remove('loading');
            el.disabled = false;
        }
    });
}

function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert ${type}`;
    alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>${message}`;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Apply filter
function applyFilter(filterValue) {
    // This would implement filtering logic
    console.log('Applying filter:', filterValue);
    loadTimetableData();
}

// Render daily classes
function renderDailyClasses() {
    const container = document.getElementById('dailyClasses');
    const todayClasses = classesData.filter(cls => {
        const classDate = new Date(cls.scheduled_date);
        const today = new Date();
        return classDate.toDateString() === today.toDateString();
    });
    
    if (todayClasses.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No classes today</h3>
                <p class="text-gray-600">Enjoy your free day!</p>
            </div>
        `;
        return;
    }
    
    const classesHtml = todayClasses.map(cls => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3 hover:shadow-md transition-shadow cursor-pointer" onclick="openClassDetails(${cls.id})">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="font-semibold text-gray-900">${cls.subject}</h3>
                    <p class="text-sm text-gray-600">${cls.tutor_name} • ${cls.student_name}</p>
                </div>
                <div class="text-right">
                    <div class="text-sm font-medium">${cls.scheduled_time}</div>
                    <div class="text-xs text-gray-500">${cls.duration} min</div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = classesHtml;
}

// Render monthly classes (simplified)
function renderMonthlyClasses() {
    const container = document.getElementById('monthGrid');
    container.innerHTML = `
        <div class="text-center py-8">
            <h3 class="text-lg font-medium text-gray-900 mb-2">Monthly View</h3>
            <p class="text-gray-600">Monthly calendar view will be implemented here</p>
        </div>
    `;
}
</script>
{% endblock %}
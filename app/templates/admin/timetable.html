{% extends "base.html" %}

{% block title %}Timetable Management{% endblock %}

{% block extra_css %}
<style>
    /* ============ MINIMAL COLOR PALETTE ============ */
    :root {
        --minimal-white: #ffffff;
        --minimal-gray-50: #f9fafb;
        --minimal-gray-100: #f3f4f6;
        --minimal-gray-200: #e5e7eb;
        --minimal-gray-300: #d1d5db;
        --minimal-gray-400: #9ca3af;
        --minimal-gray-500: #6b7280;
        --minimal-gray-600: #4b5563;
        --minimal-gray-700: #374151;
        --minimal-gray-800: #1f2937;
        --minimal-orange: var(--primary-color);
        --minimal-orange-light: var(--primary-light);
    }

    /* ============ PERFECT LAYOUT ============ */
    .main-content {
        margin-left: var(--sidebar-width) !important;
        width: calc(100% - var(--sidebar-width)) !important;
        padding: 0 !important;
        margin-top: 0 !important;
        margin-right: 0 !important;
        margin-bottom: 0 !important;
        min-height: 100vh;
        background: var(--minimal-gray-50);
        position: relative;
    }

    @media (max-width: 1024px) {
        .main-content {
            margin-left: 0 !important;
            width: 100% !important;
        }
    }

    .timetable-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    /* ============ BOX COMPONENT ============ */
    .box {
        background: var(--minimal-white);
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--minimal-gray-200);
        overflow: hidden;
    }

    .box-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--minimal-gray-200);
        background: var(--minimal-gray-50);
    }

    .box-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--minimal-gray-800);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .box-content {
        padding: 1.5rem 2rem;
    }

    /* ============ SEARCH & FILTERS ============ */
    .search-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .search-input, .filter-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--minimal-gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
        background: var(--minimal-white);
        transition: border-color 0.2s ease;
    }

    .search-input:focus, .filter-select:focus {
        outline: none;
        border-color: var(--minimal-orange);
        box-shadow: 0 0 0 3px rgba(241, 161, 80, 0.1);
    }

    .date-controls {
        display: flex;
        align-items: center;
        gap: 1rem;
        justify-content: center;
    }

    .date-nav-btn {
        padding: 0.75rem 1rem;
        background: var(--minimal-white);
        border: 1px solid var(--minimal-gray-300);
        border-radius: 8px;
        color: var(--minimal-gray-600);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
    }

    .date-nav-btn:hover {
        background: var(--minimal-gray-50);
        border-color: var(--minimal-orange);
        color: var(--minimal-orange);
    }

    .current-date {
        font-weight: 600;
        color: var(--minimal-gray-800);
        min-width: 200px;
        text-align: center;
        font-size: 1rem;
    }

    /* ============ STATISTICS ============ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: var(--minimal-white);
        border: 1px solid var(--minimal-gray-200);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.2s ease;
    }

    .stat-card:hover {
        border-color: var(--minimal-orange);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--minimal-gray-800);
        margin: 0 0 0.5rem 0;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--minimal-gray-600);
        margin: 0;
    }

    .stat-card.total { border-left: 4px solid var(--minimal-orange); }
    .stat-card.scheduled { border-left: 4px solid #3b82f6; }
    .stat-card.completed { border-left: 4px solid #10b981; }
    .stat-card.cancelled { border-left: 4px solid #ef4444; }

    /* ============ ACTION BUTTONS ============ */
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .action-btn {
        padding: 0.75rem 1.5rem;
        background: var(--minimal-white);
        border: 1px solid var(--minimal-gray-300);
        border-radius: 8px;
        color: var(--minimal-gray-600);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .action-btn:hover {
        background: var(--minimal-orange);
        color: white;
        border-color: var(--minimal-orange);
        transform: translateY(-1px);
    }

    .action-btn.export {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }

    .action-btn.export:hover {
        background: #059669;
        border-color: #059669;
    }

    /* ============ TIMETABLE DISPLAY ============ */
    .timetable-display {
        min-height: 400px;
    }

    .time-slot {
        display: flex;
        border-bottom: 1px solid var(--minimal-gray-200);
        min-height: 70px;
        align-items: stretch;
    }

    .time-slot:last-child {
        border-bottom: none;
    }

    .time-label {
        width: 120px;
        background: var(--minimal-gray-50);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--minimal-gray-600);
        border-right: 1px solid var(--minimal-gray-200);
        flex-shrink: 0;
    }

    .time-content {
        flex: 1;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        min-height: 70px;
    }

    .class-item {
        background: linear-gradient(135deg, var(--minimal-orange), var(--minimal-orange-light));
        border: 1px solid var(--minimal-gray-300);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        min-width: 200px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .class-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .class-subject {
        font-weight: 600;
        display: block;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .class-tutor {
        font-size: 0.75rem;
        opacity: 0.9;
        display: block;
    }

    .class-students {
        font-size: 0.7rem;
        opacity: 0.8;
        display: block;
        margin-top: 0.25rem;
    }

    .empty-slot {
        color: var(--minimal-gray-400);
        font-style: italic;
        font-size: 0.875rem;
    }

    /* ============ MONTHLY OVERVIEW ============ */
    .month-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
    }

    .month-card {
        background: var(--minimal-white);
        border: 1px solid var(--minimal-gray-200);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .month-card:hover {
        border-color: var(--minimal-orange);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .month-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--minimal-gray-700);
        margin-bottom: 0.5rem;
    }

    .month-count {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--minimal-gray-800);
        margin-bottom: 0.25rem;
    }

    .month-label {
        font-size: 0.75rem;
        color: var(--minimal-gray-500);
    }

    /* ============ MODAL STYLES ============ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 2rem;
    }

    .modal-content {
        background: var(--minimal-white);
        border-radius: 12px;
        max-width: 600px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        padding: 1.5rem 2rem;
        border-bottom: 1px solid var(--minimal-gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--minimal-gray-800);
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--minimal-gray-400);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: color 0.2s ease;
    }

    .modal-close:hover {
        color: var(--minimal-gray-600);
    }

    .modal-body {
        padding: 1.5rem 2rem;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--minimal-gray-200);
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: var(--minimal-gray-700);
    }

    .detail-value {
        color: var(--minimal-gray-600);
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-scheduled { background: #dbeafe; color: #1e40af; }
    .status-ongoing { background: #dcfce7; color: #166534; }
    .status-completed { background: #f3e8ff; color: #7c3aed; }
    .status-cancelled { background: #fee2e2; color: #dc2626; }

    /* ============ LOADING SPINNER ============ */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3rem;
        color: var(--minimal-gray-500);
    }

    .spinner {
        width: 32px;
        height: 32px;
        border: 3px solid var(--minimal-gray-300);
        border-top: 3px solid var(--minimal-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* ============ NOTIFICATIONS ============ */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--minimal-white);
        border: 1px solid var(--minimal-gray-200);
        border-radius: 8px;
        padding: 1rem 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        max-width: 400px;
        animation: slideIn 0.3s ease-out;
    }

    .notification.success { border-left: 4px solid #10b981; }
    .notification.error { border-left: 4px solid #ef4444; }
    .notification.info { border-left: 4px solid var(--minimal-orange); }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* ============ RESPONSIVE DESIGN ============ */
    @media (max-width: 1024px) {
        .search-grid {
            grid-template-columns: 1fr 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .month-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 768px) {
        .timetable-container {
            padding: 1rem;
            gap: 1.5rem;
        }
        
        .search-grid {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .month-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .time-slot {
            flex-direction: column;
        }
        
        .time-label {
            width: 100%;
            padding: 0.5rem;
            border-right: none;
            border-bottom: 1px solid var(--minimal-gray-200);
        }
        
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .action-btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="timetable-container">
    <!-- SEARCH & FILTERS -->
    <div class="box">
        <div class="box-header">
            <h2 class="box-title">
                <i class="fas fa-search"></i>
                Search & Filter Timetable
            </h2>
        </div>
        <div class="box-content">
            <div class="search-grid">
                <input type="text" class="search-input" placeholder="🔍 Search by subject, tutor, or student..." id="globalSearch">
                
                <select class="filter-select" id="tutorFilter">
                    <option value="">🎓 All Tutors</option>
                    {% for tutor in tutors %}
                    <option value="{{ tutor.id }}">{{ tutor.user.full_name if tutor.user else 'Unknown' }}</option>
                    {% endfor %}
                </select>
                
                <select class="filter-select" id="studentFilter">
                    <option value="">👨‍🎓 All Students</option>
                    {% for student in students %}
                    <option value="{{ student.id }}">{{ student.full_name }}</option>
                    {% endfor %}
                </select>
                
                <select class="filter-select" id="departmentFilter">
                    <option value="">🏢 All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="date-controls">
                <button class="date-nav-btn" onclick="navigateDay(-1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="current-date" id="currentDate">Today</span>
                <button class="date-nav-btn" onclick="navigateDay(1)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
                <button class="date-nav-btn" onclick="goToToday()">
                    <i class="fas fa-calendar-day"></i> Today
                </button>
            </div>
        </div>
    </div>

    <!-- STATISTICS -->
    <div class="box">
        <div class="box-header">
            <h2 class="box-title">
                <i class="fas fa-chart-bar"></i>
                Today's Statistics
            </h2>
        </div>
        <div class="box-content">
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number" id="totalClasses">0</div>
                    <div class="stat-label">Total Classes</div>
                </div>
                <div class="stat-card scheduled">
                    <div class="stat-number" id="scheduledClasses">0</div>
                    <div class="stat-label">Scheduled</div>
                </div>
                <div class="stat-card completed">
                    <div class="stat-number" id="completedClasses">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card cancelled">
                    <div class="stat-number" id="cancelledClasses">0</div>
                    <div class="stat-label">Cancelled</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn" onclick="sendTimetableEmail()">
                    <i class="fas fa-envelope"></i>
                    Send Email
                </button>
                <button class="action-btn" onclick="sendTimetableSMS()">
                    <i class="fas fa-sms"></i>
                    Send SMS
                </button>
                <a href="#" class="action-btn export" onclick="exportTimetablePDF(); return false;">
                    <i class="fas fa-file-pdf"></i>
                    Export PDF
                </a>
            </div>
        </div>
    </div>

    <!-- DAILY TIMETABLE -->
    <div class="box">
        <div class="box-header">
            <h2 class="box-title">
                <i class="fas fa-calendar-day"></i>
                Daily Timetable View
            </h2>
        </div>
        <div class="box-content">
            <div class="timetable-display" id="timetableContent">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading timetable data...
                </div>
            </div>
        </div>
    </div>

    <!-- MONTHLY OVERVIEW -->
    <div class="box">
        <div class="box-header">
            <h2 class="box-title">
                <i class="fas fa-calendar"></i>
                Monthly Overview - 2025
            </h2>
        </div>
        <div class="box-content">
            <div class="month-grid">
                <div class="month-card" onclick="viewMonth(1, 'January')">
                    <div class="month-name">January</div>
                    <div class="month-count" id="jan-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(2, 'February')">
                    <div class="month-name">February</div>
                    <div class="month-count" id="feb-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(3, 'March')">
                    <div class="month-name">March</div>
                    <div class="month-count" id="mar-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(4, 'April')">
                    <div class="month-name">April</div>
                    <div class="month-count" id="apr-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(5, 'May')">
                    <div class="month-name">May</div>
                    <div class="month-count" id="may-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(6, 'June')">
                    <div class="month-name">June</div>
                    <div class="month-count" id="jun-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(7, 'July')">
                    <div class="month-name">July</div>
                    <div class="month-count" id="jul-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(8, 'August')">
                    <div class="month-name">August</div>
                    <div class="month-count" id="aug-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(9, 'September')">
                    <div class="month-name">September</div>
                    <div class="month-count" id="sep-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(10, 'October')">
                    <div class="month-name">October</div>
                    <div class="month-count" id="oct-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(11, 'November')">
                    <div class="month-name">November</div>
                    <div class="month-count" id="nov-count">0</div>
                    <div class="month-label">classes</div>
                </div>
                <div class="month-card" onclick="viewMonth(12, 'December')">
                    <div class="month-name">December</div>
                    <div class="month-count" id="dec-count">0</div>
                    <div class="month-label">classes</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CLASS DETAILS MODAL -->
<div class="modal-overlay" id="classModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Class Details</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Class details will be populated here -->
        </div>
    </div>
</div>

<script>
// ============ COMPLETE WORKING TIMETABLE SYSTEM ============
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Initializing Complete Timetable System...');
    
    initializeTimetable();
    updateDateDisplay();
    loadTimetableData();
    loadMonthlyStats();
    
    // Add event listeners
    document.getElementById('globalSearch').addEventListener('input', debounce(handleSearch, 500));
    document.getElementById('tutorFilter').addEventListener('change', handleFilterChange);
    document.getElementById('studentFilter').addEventListener('change', handleFilterChange);
    document.getElementById('departmentFilter').addEventListener('change', handleFilterChange);
    
    // Auto-refresh every 5 minutes
    setInterval(loadTimetableData, 300000);
});

// ============ GLOBAL VARIABLES ============
let currentDate = new Date();
let classesData = [];
let searchFilters = {};

// ============ INITIALIZATION ============
function initializeTimetable() {
    console.log('Setting up timetable system...');
    
    // Close modal when clicking outside
    document.getElementById('classModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    console.log('✅ Timetable system initialized');
}

// ============ DATA LOADING ============
async function loadTimetableData() {
    console.log('📊 Loading timetable data...');
    showLoading(true);
    
    try {
        const endpoint = '/admin/api/v1/timetable/today';
        const params = new URLSearchParams({
            date: currentDate.toISOString().split('T')[0],
            ...searchFilters
        });
        
        console.log(`🔗 API Call: ${endpoint}?${params}`);
        
        const response = await fetch(`${endpoint}?${params}`, {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            classesData = data.classes || [];
            updateStats(data.stats);
            renderTimetable();
            console.log(`✅ Loaded ${classesData.length} classes successfully`);
        } else {
            throw new Error(data.error || 'API returned error');
        }
        
    } catch (error) {
        console.error('❌ Error loading timetable:', error);
        showNotification('Failed to load timetable data. Please try again.', 'error');
        
        // Show empty state
        classesData = [];
        updateStats({total_classes: 0, today: {scheduled: 0, ongoing: 0, completed: 0, cancelled: 0}});
        renderEmptyTimetable();
    } finally {
        showLoading(false);
    }
}

// ============ RENDER TIMETABLE ============
function renderTimetable() {
    const container = document.getElementById('timetableContent');
    
    if (!classesData || classesData.length === 0) {
        renderEmptyTimetable();
        return;
    }
    
    // Group classes by hour (9 AM to 9 PM)
    const classesByTime = {};
    classesData.forEach(cls => {
        const timeStr = cls.scheduled_time || '00:00';
        const hour = parseInt(timeStr.split(':')[0]);
        const timeKey = hour;
        
        if (!classesByTime[timeKey]) {
            classesByTime[timeKey] = [];
        }
        classesByTime[timeKey].push(cls);
    });
    
    let html = '';
    
    // Generate time slots from 9 AM to 9 PM
    for (let hour = 9; hour <= 21; hour++) {
        const displayTime = hour <= 12 ? 
            (hour === 12 ? '12:00 PM' : `${hour}:00 AM`) : 
            `${hour - 12}:00 PM`;
        
        const timeClasses = classesByTime[hour] || [];
        
        html += `
            <div class="time-slot">
                <div class="time-label">${displayTime}</div>
                <div class="time-content">
                    ${renderTimeClasses(timeClasses)}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function renderTimeClasses(classes) {
    if (classes.length === 0) {
        return '<span class="empty-slot">No classes scheduled</span>';
    }
    
    let html = '';
    
    classes.forEach(cls => {
        const studentInfo = cls.student_count > 0 ? 
            `${cls.student_count} student${cls.student_count > 1 ? 's' : ''}` : 
            'No students';
        
        html += `
            <div class="class-item" onclick="openClassDetails(${cls.id})">
                <span class="class-subject">${cls.subject}</span>
                <span class="class-tutor">👨‍🏫 ${cls.tutor_name}</span>
                <span class="class-students">👥 ${studentInfo}</span>
            </div>
        `;
    });
    
    return html;
}

function renderEmptyTimetable() {
    const container = document.getElementById('timetableContent');
    container.innerHTML = `
        <div style="text-align: center; padding: 3rem; color: var(--minimal-gray-500);">
            <i class="fas fa-calendar-times" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
            <h3 style="margin: 0 0 1rem 0; color: var(--minimal-gray-600);">No Classes Scheduled</h3>
            <p style="margin: 0;">No classes found for the selected date and filters.</p>
        </div>
    `;
}

// ============ CLASS DETAILS MODAL ============
async function openClassDetails(classId) {
    try {
        showLoading(true);
        
        const response = await fetch(`/admin/api/v1/timetable/class/${classId}`, {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            const cls = data.class;
            document.getElementById('modalTitle').textContent = `${cls.subject} - Class Details`;
            
            let modalContent = `
                <div class="detail-row">
                    <span class="detail-label">Subject:</span>
                    <span class="detail-value">${cls.subject}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Date & Time:</span>
                    <span class="detail-value">${cls.scheduled_date} at ${cls.scheduled_time}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Duration:</span>
                    <span class="detail-value">${cls.duration} minutes</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value"><span class="status-badge status-${cls.status}">${cls.status}</span></span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tutor:</span>
                    <span class="detail-value">${cls.tutor.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Class Type:</span>
                    <span class="detail-value">${cls.class_type}</span>
                </div>
            `;
            
            if (cls.grade) {
                modalContent += `
                    <div class="detail-row">
                        <span class="detail-label">Grade:</span>
                        <span class="detail-value">${cls.grade}</span>
                    </div>
                `;
            }
            
            if (cls.students && cls.students.length > 0) {
                modalContent += `
                    <div class="detail-row">
                        <span class="detail-label">Students:</span>
                        <span class="detail-value">${cls.students.map(s => s.name).join(', ')}</span>
                    </div>
                `;
            }
            
            if (cls.meeting_link) {
                modalContent += `
                    <div class="detail-row">
                        <span class="detail-label">Meeting Link:</span>
                        <span class="detail-value"><a href="${cls.meeting_link}" target="_blank" style="color: var(--minimal-orange);">Join Class</a></span>
                    </div>
                `;
            }
            
            if (cls.class_notes) {
                modalContent += `
                    <div class="detail-row">
                        <span class="detail-label">Notes:</span>
                        <span class="detail-value">${cls.class_notes}</span>
                    </div>
                `;
            }
            
            document.getElementById('modalBody').innerHTML = modalContent;
            document.getElementById('classModal').style.display = 'flex';
        } else {
            showNotification('Failed to load class details', 'error');
        }
        
    } catch (error) {
        console.error('Error loading class details:', error);
        showNotification('Failed to load class details', 'error');
    } finally {
        showLoading(false);
    }
}

function closeModal() {
    document.getElementById('classModal').style.display = 'none';
}

// ============ MONTHLY STATS ============
async function loadMonthlyStats() {
    try {
        const response = await fetch('/admin/api/v1/timetable/monthly-stats', {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                Object.entries(data.stats).forEach(([month, count]) => {
                    const element = document.getElementById(`${month}-count`);
                    if (element) {
                        element.textContent = count;
                    }
                });
                console.log('✅ Monthly stats loaded');
            }
        }
    } catch (error) {
        console.error('Error loading monthly stats:', error);
        // Set default values
        const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
        months.forEach(month => {
            const element = document.getElementById(`${month}-count`);
            if (element) {
                element.textContent = '0';
            }
        });
    }
}

// ============ MONTH VIEW DETAILS ============
async function viewMonth(monthNumber, monthName) {
    try {
        showLoading(true);
        
        const response = await fetch(`/admin/api/v1/timetable/month-details/${monthNumber}`, {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                showNotification(`${monthName}: ${data.total_classes} classes found`, 'info');
                console.log('Month details:', data.classes_by_date);
            } else {
                showNotification(`No data available for ${monthName}`, 'info');
            }
        }
    } catch (error) {
        console.error('Error loading month details:', error);
        showNotification(`Failed to load ${monthName} details`, 'error');
    } finally {
        showLoading(false);
    }
}

// ============ NAVIGATION ============
function navigateDay(direction) {
    currentDate.setDate(currentDate.getDate() + direction);
    updateDateDisplay();
    loadTimetableData();
}

function goToToday() {
    currentDate = new Date();
    updateDateDisplay();
    loadTimetableData();
}

function updateDateDisplay() {
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    document.getElementById('currentDate').textContent = currentDate.toLocaleDateString('en-US', options);
}

// ============ STATISTICS ============
function updateStats(stats) {
    document.getElementById('totalClasses').textContent = stats.total_classes || 0;
    document.getElementById('scheduledClasses').textContent = stats.today?.scheduled || 0;
    document.getElementById('completedClasses').textContent = stats.today?.completed || 0;
    document.getElementById('cancelledClasses').textContent = stats.today?.cancelled || 0;
}

// ============ SEARCH & FILTERS ============
function handleSearch(event) {
    const searchTerm = event.target.value.trim();
    if (searchTerm.length >= 3) {
        searchFilters.search = searchTerm;
        loadTimetableData();
    } else if (searchTerm.length === 0) {
        delete searchFilters.search;
        loadTimetableData();
    }
}

function handleFilterChange() {
    // Clear previous filters
    searchFilters = {};
    
    const tutorId = document.getElementById('tutorFilter').value;
    const studentId = document.getElementById('studentFilter').value;
    const deptId = document.getElementById('departmentFilter').value;
    
    if (tutorId) searchFilters.tutor_id = tutorId;
    if (studentId) searchFilters.student_id = studentId;
    if (deptId) searchFilters.department_id = deptId;
    
    loadTimetableData();
}

// ============ EXPORT FUNCTIONALITY ============
async function exportTimetablePDF() {
    try {
        showLoading(true);
        showNotification('Generating PDF...', 'info');
        
        const params = new URLSearchParams({
            date: currentDate.toISOString().split('T')[0],
            view: 'today',
            ...searchFilters
        });
        
        const response = await fetch(`/admin/api/v1/timetable/export-pdf?${params}`, {
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timetable_${currentDate.toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('PDF downloaded successfully!', 'success');
        } else {
            showNotification('Failed to generate PDF', 'error');
        }
    } catch (error) {
        console.error('Error exporting PDF:', error);
        showNotification('Failed to export PDF', 'error');
    } finally {
        showLoading(false);
    }
}

// ============ SEND FUNCTIONALITY ============
async function sendTimetableEmail() {
    try {
        showLoading(true);
        showNotification('Sending timetable via email...', 'info');
        
        const params = new URLSearchParams({
            date: currentDate.toISOString().split('T')[0],
            view: 'today',
            recipients: 'all'
        });
        
        const response = await fetch(`/admin/api/v1/timetable/send-email?${params}`, {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                showNotification(`Timetable sent to ${data.sent_count} recipients via email!`, 'success');
            } else {
                showNotification(data.error || 'Failed to send email', 'error');
            }
        } else {
            showNotification('Failed to send timetable via email', 'error');
        }
    } catch (error) {
        console.error('Error sending email:', error);
        showNotification('Failed to send timetable via email', 'error');
    } finally {
        showLoading(false);
    }
}

async function sendTimetableSMS() {
    try {
        showLoading(true);
        showNotification('SMS functionality coming soon...', 'info');
    } catch (error) {
        console.error('Error sending SMS:', error);
        showNotification('Failed to send SMS', 'error');
    } finally {
        showLoading(false);
    }
}

// ============ UTILITY FUNCTIONS ============
function showLoading(show) {
    const container = document.getElementById('timetableContent');
    if (show && container) {
        container.innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                Loading timetable data...
            </div>
        `;
    }
}

function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const iconMap = {
        'success': 'fa-check-circle',
        'error': 'fa-exclamation-circle',
        'info': 'fa-info-circle'
    };
    
    notification.innerHTML = `
        <i class="fas ${iconMap[type] || 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

console.log('✅ Complete Timetable System loaded successfully! 🚀');
</script>
{% endblock %}
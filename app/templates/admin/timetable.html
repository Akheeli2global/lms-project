{% extends "base.html" %}
{% set page_title = "Timetable Management" %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-calendar-alt"></i>
                Timetable Management
            </h1>
            <p class="text-muted mb-0">View and manage class schedules across all departments</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="exportTimetable()">
                <i class="fas fa-download"></i>
                Export
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTempClassModal">
                <i class="fas fa-plus"></i>
                Add Temp Class
            </button>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">View Type</label>
                    <select class="form-select" id="viewType" onchange="changeView()">
                        <option value="today">Today</option>
                        <option value="week" selected>This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Filter By</label>
                    <select class="form-select" id="filterType" onchange="updateFilterOptions()">
                        <option value="all">All Classes</option>
                        <option value="department">Department</option>
                        <option value="tutor">Tutor</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Filter Value</label>
                    <select class="form-select" id="filterValue" onchange="applyFilter()">
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-secondary d-block w-100" onclick="resetFilters()">
                        <i class="fas fa-refresh"></i>
                        Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Controls -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="btn-group" role="group">
            <button class="btn btn-outline-primary" onclick="navigateTime('prev')">
                <i class="fas fa-chevron-left"></i>
                Previous
            </button>
            <button class="btn btn-outline-primary" onclick="navigateTime('today')">
                <i class="fas fa-calendar-day"></i>
                Today
            </button>
            <button class="btn btn-outline-primary" onclick="navigateTime('next')">
                Next
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <div class="date-display">
            <h5 class="mb-0" id="currentDateDisplay">Loading...</h5>
        </div>
    </div>

    <!-- Timetable Content -->
    <div class="card">
        <div class="card-body p-0">
            <div id="timetableContent">
                <!-- Weekly View (Default) -->
                <div id="weekView" class="timetable-view">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 timetable-table">
                            <thead class="table-dark">
                                <tr>
                                    <th class="time-column">Time</th>
                                    <th>Monday</th>
                                    <th>Tuesday</th>
                                    <th>Wednesday</th>
                                    <th>Thursday</th>
                                    <th>Friday</th>
                                    <th>Saturday</th>
                                    <th>Sunday</th>
                                </tr>
                            </thead>
                            <tbody id="weekTableBody">
                                <!-- Time slots will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Today View -->
                <div id="todayView" class="timetable-view d-none">
                    <div class="row">
                        <div class="col-12">
                            <div id="todayClassList" class="class-list">
                                <!-- Today's classes will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly View -->
                <div id="monthView" class="timetable-view d-none">
                    <div class="calendar-container">
                        <div id="monthCalendar" class="month-calendar">
                            <!-- Monthly calendar will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mt-4">
        <div class="col-md-3">
            <div class="card stats-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Classes</h6>
                            <h3 class="mb-0" id="totalClasses">0</h3>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Completed</h6>
                            <h3 class="mb-0" id="completedClasses">0</h3>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Ongoing</h6>
                            <h3 class="mb-0" id="ongoingClasses">0</h3>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-play-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Scheduled</h6>
                            <h3 class="mb-0" id="scheduledClasses">0</h3>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Temporary Class Modal -->
<div class="modal fade" id="addTempClassModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Temporary Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="tempClassForm" onsubmit="addTempClass(event)">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Tutor *</label>
                            <select class="form-select" name="tutor_id" required>
                                <option value="">Select Tutor...</option>
                                {% for tutor in tutors %}
                                <option value="{{ tutor.id }}">{{ tutor.user.full_name }} ({{ tutor.subjects }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Student *</label>
                            <select class="form-select" name="student_id" required>
                                <option value="">Select Student...</option>
                                {% for student in students %}
                                <option value="{{ student.id }}">{{ student.full_name }} - Grade {{ student.grade }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Subject *</label>
                            <input type="text" class="form-control" name="subject" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Duration (minutes) *</label>
                            <select class="form-select" name="duration" required>
                                <option value="30">30 minutes</option>
                                <option value="45">45 minutes</option>
                                <option value="60" selected>60 minutes</option>
                                <option value="90">90 minutes</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control" name="scheduled_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Time *</label>
                            <input type="time" class="form-control" name="scheduled_time" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" rows="3" placeholder="Additional notes for this class..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Add Class
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Class Details Modal -->
<div class="modal fade" id="classDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Class Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="classDetailsContent">
                <!-- Class details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="rescheduleClass()">
                    <i class="fas fa-clock"></i>
                    Reschedule
                </button>
                <button type="button" class="btn btn-danger" onclick="cancelClass()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.timetable-table {
    font-size: 0.875rem;
}

.time-column {
    width: 100px;
    background-color: #f8f9fa;
    font-weight: 600;
}

.class-slot {
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 4px;
    cursor: pointer;
    transition: transform 0.2s;
    font-size: 0.75rem;
    line-height: 1.2;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.class-slot:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.class-slot.status-scheduled {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-left: 4px solid #2196f3;
}

.class-slot.status-ongoing {
    background: linear-gradient(135deg, #fff3e0, #ffcc02);
    border-left: 4px solid #ff9800;
}

.class-slot.status-completed {
    background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
    border-left: 4px solid #4caf50;
}

.class-slot.status-cancelled {
    background: linear-gradient(135deg, #ffebee, #ffcdd2);
    border-left: 4px solid #f44336;
}

.class-time {
    font-weight: bold;
    color: #333;
}

.class-subject {
    font-weight: 600;
    margin-bottom: 2px;
}

.class-tutor, .class-student {
    font-size: 0.7rem;
    color: #666;
}

.stats-card {
    border: none;
    border-radius: 12px;
    overflow: hidden;
}

.stats-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.class-list .card {
    margin-bottom: 1rem;
    border-left: 4px solid;
    transition: transform 0.2s;
}

.class-list .card:hover {
    transform: translateX(4px);
}

.class-list .card.status-scheduled {
    border-color: #2196f3;
}

.class-list .card.status-ongoing {
    border-color: #ff9800;
}

.class-list .card.status-completed {
    border-color: #4caf50;
}

.month-calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
}

.calendar-day {
    background: white;
    min-height: 120px;
    padding: 8px;
    position: relative;
    display: flex;
    flex-direction: column;
}

.calendar-day-number {
    font-weight: bold;
    margin-bottom: 4px;
}

.calendar-day.other-month {
    background: #f5f5f5;
    color: #ccc;
}

.calendar-day.today {
    background: #e3f2fd;
}

.calendar-class {
    background: #2196f3;
    color: white;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 0.7rem;
    margin-bottom: 2px;
    cursor: pointer;
}
</style>

<script>
let currentDate = new Date();
let currentView = 'week';
let currentFilter = { type: 'all', value: '' };

// Initialize timetable
document.addEventListener('DOMContentLoaded', function() {
    updateFilterOptions();
    loadTimetable();
    setInterval(updateStats, 30000); // Update stats every 30 seconds
});

function changeView() {
    currentView = document.getElementById('viewType').value;
    
    // Hide all views
    document.querySelectorAll('.timetable-view').forEach(view => {
        view.classList.add('d-none');
    });
    
    // Show selected view
    document.getElementById(currentView + 'View').classList.remove('d-none');
    
    loadTimetable();
}

function updateFilterOptions() {
    const filterType = document.getElementById('filterType').value;
    const filterValue = document.getElementById('filterValue');
    
    filterValue.innerHTML = '<option value="">Select...</option>';
    
    if (filterType === 'department') {
        {% for dept in departments %}
        filterValue.innerHTML += '<option value="{{ dept.id }}">{{ dept.name }}</option>';
        {% endfor %}
    } else if (filterType === 'tutor') {
        {% for tutor in tutors %}
        filterValue.innerHTML += '<option value="{{ tutor.id }}">{{ tutor.user.full_name }}</option>';
        {% endfor %}
    } else if (filterType === 'student') {
        {% for student in students %}
        filterValue.innerHTML += '<option value="{{ student.id }}">{{ student.full_name }}</option>';
        {% endfor %}
    }
}

function applyFilter() {
    currentFilter.type = document.getElementById('filterType').value;
    currentFilter.value = document.getElementById('filterValue').value;
    loadTimetable();
}

function resetFilters() {
    document.getElementById('filterType').value = 'all';
    document.getElementById('filterValue').innerHTML = '<option value="">Select...</option>';
    currentFilter = { type: 'all', value: '' };
    loadTimetable();
}

function navigateTime(direction) {
    if (direction === 'prev') {
        if (currentView === 'today') {
            currentDate.setDate(currentDate.getDate() - 1);
        } else if (currentView === 'week') {
            currentDate.setDate(currentDate.getDate() - 7);
        } else if (currentView === 'month') {
            currentDate.setMonth(currentDate.getMonth() - 1);
        }
    } else if (direction === 'next') {
        if (currentView === 'today') {
            currentDate.setDate(currentDate.getDate() + 1);
        } else if (currentView === 'week') {
            currentDate.setDate(currentDate.getDate() + 7);
        } else if (currentView === 'month') {
            currentDate.setMonth(currentDate.getMonth() + 1);
        }
    } else if (direction === 'today') {
        currentDate = new Date();
    }
    
    loadTimetable();
}

function loadTimetable() {
    updateDateDisplay();
    
    const endpoint = `/api/v1/timetable/${currentView}`;
    const params = new URLSearchParams({
        date: currentDate.toISOString().split('T')[0],
        filter_type: currentFilter.type,
        filter_value: currentFilter.value
    });
    
    fetch(`${endpoint}?${params}`)
        .then(response => response.json())
        .then(data => {
            if (currentView === 'week') {
                renderWeekView(data);
            } else if (currentView === 'today') {
                renderTodayView(data);
            } else if (currentView === 'month') {
                renderMonthView(data);
            }
            updateStats(data.stats);
        })
        .catch(error => {
            console.error('Error loading timetable:', error);
            showAlert('Error loading timetable data', 'danger');
        });
}

function renderWeekView(data) {
    const tbody = document.getElementById('weekTableBody');
    tbody.innerHTML = '';
    
    const timeSlots = generateTimeSlots();
    
    timeSlots.forEach(timeSlot => {
        const row = document.createElement('tr');
        row.innerHTML = `<td class="time-column">${timeSlot}</td>`;
        
        // Add 7 day columns
        for (let day = 0; day < 7; day++) {
            const cell = document.createElement('td');
            cell.style.minWidth = '150px';
            cell.style.verticalAlign = 'top';
            
            // Find classes for this time slot and day
            const dayClasses = data.classes.filter(cls => {
                const classDay = new Date(cls.scheduled_date).getDay();
                const classTime = cls.scheduled_time.substring(0, 5);
                return classDay === day && classTime === timeSlot;
            });
            
            dayClasses.forEach(cls => {
                cell.appendChild(createClassSlot(cls));
            });
            
            row.appendChild(cell);
        }
        
        tbody.appendChild(row);
    });
}

function renderTodayView(data) {
    const container = document.getElementById('todayClassList');
    container.innerHTML = '';
    
    if (data.classes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                <h5>No classes scheduled for today</h5>
                <p class="text-muted">Enjoy your free day!</p>
            </div>
        `;
        return;
    }
    
    data.classes.forEach(cls => {
        const card = document.createElement('div');
        card.className = `card status-${cls.status}`;
        card.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title">${cls.subject}</h6>
                        <p class="card-text">
                            <i class="fas fa-clock"></i> ${cls.scheduled_time} - ${cls.end_time}<br>
                            <i class="fas fa-chalkboard-teacher"></i> ${cls.tutor_name}<br>
                            <i class="fas fa-user-graduate"></i> ${cls.student_name}
                        </p>
                    </div>
                    <div>
                        <span class="badge bg-${getStatusColor(cls.status)}">${cls.status}</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="viewClassDetails(${cls.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function renderMonthView(data) {
    const container = document.getElementById('monthCalendar');
    container.innerHTML = '';
    
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    
    // Add day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.style.background = '#333';
        header.style.color = 'white';
        header.style.padding = '8px';
        header.style.textAlign = 'center';
        header.style.fontWeight = 'bold';
        header.textContent = day;
        container.appendChild(header);
    });
    
    // Add empty cells for days before month start
    for (let i = 0; i < firstDay.getDay(); i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day other-month';
        container.appendChild(emptyDay);
    }
    
    // Add days of the month
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        const today = new Date();
        if (day === today.getDate() && 
            currentDate.getMonth() === today.getMonth() && 
            currentDate.getFullYear() === today.getFullYear()) {
            dayDiv.classList.add('today');
        }
        
        dayDiv.innerHTML = `<div class="calendar-day-number">${day}</div>`;
        
        // Add classes for this day
        const dayClasses = data.classes.filter(cls => {
            const classDate = new Date(cls.scheduled_date);
            return classDate.getDate() === day;
        });
        
        dayClasses.forEach(cls => {
            const classDiv = document.createElement('div');
            classDiv.className = 'calendar-class';
            classDiv.textContent = `${cls.scheduled_time} ${cls.subject}`;
            classDiv.onclick = () => viewClassDetails(cls.id);
            dayDiv.appendChild(classDiv);
        });
        
        container.appendChild(dayDiv);
    }
}

function createClassSlot(cls) {
    const slot = document.createElement('div');
    slot.className = `class-slot status-${cls.status}`;
    slot.onclick = () => viewClassDetails(cls.id);
    
    slot.innerHTML = `
        <div class="class-time">${cls.scheduled_time}</div>
        <div class="class-subject">${cls.subject}</div>
        <div class="class-tutor">${cls.tutor_name}</div>
        <div class="class-student">${cls.student_name}</div>
    `;
    
    return slot;
}

function generateTimeSlots() {
    const slots = [];
    for (let hour = 6; hour < 22; hour++) {
        slots.push(`${hour.toString().padStart(2, '0')}:00`);
        slots.push(`${hour.toString().padStart(2, '0')}:30`);
    }
    return slots;
}

function updateDateDisplay() {
    const display = document.getElementById('currentDateDisplay');
    
    if (currentView === 'today') {
        display.textContent = currentDate.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    } else if (currentView === 'week') {
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        
        display.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
    } else if (currentView === 'month') {
        display.textContent = currentDate.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long' 
        });
    }
}

function updateStats(stats) {
    if (stats) {
        document.getElementById('totalClasses').textContent = stats.total || 0;
        document.getElementById('completedClasses').textContent = stats.completed || 0;
        document.getElementById('ongoingClasses').textContent = stats.ongoing || 0;
        document.getElementById('scheduledClasses').textContent = stats.scheduled || 0;
    }
}

function getStatusColor(status) {
    const colors = {
        'scheduled': 'primary',
        'ongoing': 'warning',
        'completed': 'success',
        'cancelled': 'danger'
    };
    return colors[status] || 'secondary';
}

function addTempClass(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    fetch('/api/v1/timetable/temp-class', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showAlert('Temporary class added successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addTempClassModal')).hide();
            loadTimetable();
            event.target.reset();
        } else {
            showAlert(result.message || 'Error adding temporary class', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding temporary class', 'danger');
    });
}

function viewClassDetails(classId) {
    fetch(`/api/v1/classes/${classId}`)
        .then(response => response.json())
        .then(cls => {
            document.getElementById('classDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Class Information</h6>
                        <p><strong>Subject:</strong> ${cls.subject}</p>
                        <p><strong>Date:</strong> ${cls.scheduled_date}</p>
                        <p><strong>Time:</strong> ${cls.scheduled_time} - ${cls.end_time}</p>
                        <p><strong>Duration:</strong> ${cls.duration} minutes</p>
                        <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(cls.status)}">${cls.status}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Participants</h6>
                        <p><strong>Tutor:</strong> ${cls.tutor_name}</p>
                        <p><strong>Student:</strong> ${cls.student_name}</p>
                        ${cls.meeting_link ? `<p><strong>Meeting Link:</strong> <a href="${cls.meeting_link}" target="_blank">Join Class</a></p>` : ''}
                    </div>
                </div>
                ${cls.notes ? `<div class="mt-3"><h6>Notes</h6><p>${cls.notes}</p></div>` : ''}
            `;
            
            // Store class ID for actions
            document.getElementById('classDetailsModal').dataset.classId = classId;
            
            new bootstrap.Modal(document.getElementById('classDetailsModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading class details', 'danger');
        });
}

function exportTimetable() {
    const params = new URLSearchParams({
        view: currentView,
        date: currentDate.toISOString().split('T')[0],
        filter_type: currentFilter.type,
        filter_value: currentFilter.value
    });
    
    window.open(`/api/v1/timetable/export?${params}`, '_blank');
}

function rescheduleClass() {
    const classId = document.getElementById('classDetailsModal').dataset.classId;
    // Implement reschedule functionality
    showAlert('Reschedule functionality to be implemented', 'info');
}

function cancelClass() {
    const classId = document.getElementById('classDetailsModal').dataset.classId;
    
    if (confirm('Are you sure you want to cancel this class?')) {
        fetch(`/api/v1/classes/${classId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Class cancelled successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('classDetailsModal')).hide();
                loadTimetable();
            } else {
                showAlert(result.message || 'Error cancelling class', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error cancelling class', 'danger');
        });
    }
}

function showAlert(message, type) {
    // Create and show bootstrap alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
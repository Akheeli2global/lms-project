{% extends "layouts/base.html" %}
{% set active_page = "escalations" %}

{% block title %}Escalation #{{ escalation.id }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Escalation #{{ escalation.id }}</h1>
            <p class="text-muted">{{ escalation.title }}</p>
        </div>
        <div>
            <a href="{{ url_for('escalation.list_escalations') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Main Details -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Escalation Details</h5>
                    <div>
                        {% if escalation.priority == 'high' %}
                            <span class="badge bg-danger">High Priority</span>
                        {% elif escalation.priority == 'medium' %}
                            <span class="badge bg-warning">Medium Priority</span>
                        {% else %}
                            <span class="badge bg-info">Low Priority</span>
                        {% endif %}
                        
                        {% if escalation.status == 'open' %}
                            <span class="badge bg-warning">Open</span>
                        {% elif escalation.status == 'assigned' %}
                            <span class="badge bg-info">Assigned</span>
                        {% elif escalation.status == 'in_progress' %}
                            <span class="badge bg-primary">In Progress</span>
                        {% elif escalation.status == 'resolved' %}
                            <span class="badge bg-success">Resolved</span>
                        {% else %}
                            <span class="badge bg-secondary">Closed</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Category:</strong> {{ escalation.category|title }}
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong> {{ escalation.created_at|datetime }}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Created by:</strong> {{ escalation.creator.full_name }}
                        </div>
                        <div class="col-md-6">
                            <strong>Due Date:</strong> 
                            {% if escalation.due_date %}
                                <span {% if escalation.is_overdue() %}class="text-danger fw-bold"{% endif %}>
                                    {{ escalation.due_date|datetime }}
                                    {% if escalation.is_overdue() %}
                                        <i class="fas fa-exclamation-triangle ms-1"></i>
                                    {% endif %}
                                </span>
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Assigned to:</strong> 
                            {% if escalation.assignee %}
                                {{ escalation.assignee.full_name }}
                            {% else %}
                                <span class="text-muted">Unassigned</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Department:</strong> 
                            {% if escalation.department %}
                                {{ escalation.department.name }}
                            {% else %}
                                <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <strong>Description:</strong>
                        <div class="mt-2 p-3 bg-light rounded">
                            {{ escalation.description|nl2br }}
                        </div>
                    </div>

                    <!-- Related Records -->
                    {% set related = escalation.get_related_records() %}
                    {% if related or student or tutor %}
                        <div class="mb-4">
                            <strong>Related Records:</strong>
                            <div class="mt-2">
                                {% if student %}
                                    <div class="d-inline-block me-3">
                                        <span class="badge bg-primary">Student</span>
                                        <a href="{{ url_for('admin.view_student', student_id=student.id) }}" class="ms-1">
                                            {{ student.full_name }} ({{ student.student_id }})
                                        </a>
                                    </div>
                                {% endif %}
                                {% if tutor %}
                                    <div class="d-inline-block">
                                        <span class="badge bg-success">Tutor</span>
                                        <a href="{{ url_for('admin.view_tutor', tutor_id=tutor.id) }}" class="ms-1">
                                            {{ tutor.user.full_name }} ({{ tutor.employee_id }})
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Resolution -->
                    {% if escalation.resolution %}
                        <div class="mt-4">
                            <strong>Resolution:</strong>
                            <div class="mt-2 p-3 bg-success bg-opacity-10 border border-success rounded">
                                {{ escalation.resolution|nl2br }}
                                <div class="mt-2 small text-muted">
                                    Resolved on {{ escalation.resolution_date|datetime }} 
                                    by {{ escalation.resolver.full_name if escalation.resolver else 'Unknown' }}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Comments -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Comments & Updates</h5>
                </div>
                <div class="card-body">
                    <!-- Add Comment Form -->
                    <form id="commentForm" class="mb-4">
                        <div class="input-group">
                            <textarea class="form-control" id="commentText" placeholder="Add a comment..." rows="3"></textarea>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i> Post
                            </button>
                        </div>
                    </form>

                    <!-- Comments List -->
                    <div id="commentsList">
                        {% for comment in comments %}
                            <div class="border-bottom pb-3 mb-3">
                                <div class="d-flex justify-content-between">
                                    <strong>{{ comment.user_name }}</strong>
                                    <small class="text-muted">{{ comment.timestamp|datetime }}</small>
                                </div>
                                <div class="mt-1">{{ comment.comment|nl2br }}</div>
                            </div>
                        {% endfor %}
                        
                        {% if not comments %}
                            <p class="text-muted text-center">No comments yet</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Actions</h6>
                </div>
                <div class="card-body">
                    <!-- Assignment -->
                    {% if current_user.role in ['superadmin', 'admin'] or 
                          (current_user.role == 'coordinator' and escalation.department_id == current_user.department_id) %}
                        <div class="mb-3">
                            <label for="assignUser" class="form-label">Assign to:</label>
                            <div class="input-group">
                                <select class="form-select" id="assignUser">
                                    <option value="">Select User</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}" {% if escalation.assigned_to == user.id %}selected{% endif %}>
                                            {{ user.full_name }} ({{ user.role|title }})
                                        </option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-outline-primary" id="assignBtn">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Status Update -->
                    {% if escalation.assigned_to == current_user.id or 
                          current_user.role in ['superadmin', 'admin'] or
                          (current_user.role == 'coordinator' and escalation.department_id == current_user.department_id) %}
                        <div class="mb-3">
                            <label for="statusSelect" class="form-label">Status:</label>
                            <div class="input-group">
                                <select class="form-select" id="statusSelect">
                                    {% for value, label in statuses %}
                                        <option value="{{ value }}" {% if escalation.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-outline-primary" id="statusBtn">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                    {% endif %}

                    <!-- Resolution -->
                    {% if escalation.status not in ['resolved', 'closed'] and 
                          (escalation.assigned_to == current_user.id or 
                           current_user.role in ['superadmin', 'admin'] or
                           (current_user.role == 'coordinator' and escalation.department_id == current_user.department_id)) %}
                        <button class="btn btn-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#resolveModal">
                            <i class="fas fa-check"></i> Mark as Resolved
                        </button>
                    {% endif %}

                    <!-- Close -->
                    {% if escalation.status == 'resolved' and 
                          current_user.role in ['superadmin', 'admin'] or
                          (current_user.role == 'coordinator' and escalation.department_id == current_user.department_id) %}
                        <button class="btn btn-secondary w-100" id="closeBtn">
                            <i class="fas fa-times"></i> Close Escalation
                        </button>
                    {% endif %}
                </div>
            </div>

            <!-- Timeline -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Activity Timeline</h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="timeline-title">Created</h6>
                                <p class="timeline-text">{{ escalation.created_at|datetime }}</p>
                                <small class="text-muted">by {{ escalation.creator.full_name }}</small>
                            </div>
                        </div>

                        {% if escalation.assigned_to %}
                            <div class="timeline-item">
                                <div class="timeline-marker bg-info"></div>
                                <div class="timeline-content">
                                    <h6 class="timeline-title">Assigned</h6>
                                    <p class="timeline-text">{{ escalation.assignee.full_name }}</p>
                                </div>
                            </div>
                        {% endif %}

                        {% if escalation.resolution_date %}
                            <div class="timeline-item">
                                <div class="timeline-marker bg-success"></div>
                                <div class="timeline-content">
                                    <h6 class="timeline-title">Resolved</h6>
                                    <p class="timeline-text">{{ escalation.resolution_date|datetime }}</p>
                                    <small class="text-muted">by {{ escalation.resolver.full_name if escalation.resolver else 'Unknown' }}</small>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resolve Modal -->
<div class="modal fade" id="resolveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resolve Escalation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="resolveForm">
                    <div class="mb-3">
                        <label for="resolutionText" class="form-label">Resolution Description</label>
                        <textarea class="form-control" id="resolutionText" rows="4" required
                                  placeholder="Describe how this issue was resolved..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="resolveSubmit">Resolve</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const escalationId = {{ escalation.id }};

    // Comment posting
    document.getElementById('commentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const comment = document.getElementById('commentText').value.trim();
        if (!comment) return;

        fetch(`/escalations/${escalationId}/add-comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({comment: comment})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error adding comment');
            }
        });
    });

    // Assignment
    document.getElementById('assignBtn')?.addEventListener('click', function() {
        const userId = document.getElementById('assignUser').value;
        if (!userId) return;

        fetch(`/escalations/${escalationId}/assign`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({user_id: parseInt(userId)})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error assigning escalation');
            }
        });
    });

    // Status update
    document.getElementById('statusBtn')?.addEventListener('click', function() {
        const status = document.getElementById('statusSelect').value;
        
        fetch(`/escalations/${escalationId}/update-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({status: status})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error updating status');
            }
        });
    });

    // Resolution
    document.getElementById('resolveSubmit')?.addEventListener('click', function() {
        const resolution = document.getElementById('resolutionText').value.trim();
        if (!resolution) {
            alert('Please provide a resolution description');
            return;
        }

        fetch(`/escalations/${escalationId}/resolve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({resolution: resolution})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error resolving escalation');
            }
        });
    });

    // Close escalation
    document.getElementById('closeBtn')?.addEventListener('click', function() {
        if (!confirm('Are you sure you want to close this escalation?')) return;

        fetch(`/escalations/${escalationId}/close`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error closing escalation');
            }
        });
    });
});
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -30px;
    top: 17px;
    width: 2px;
    height: calc(100% + 5px);
    background-color: #dee2e6;
}

.timeline-title {
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.timeline-text {
    font-size: 0.85rem;
    margin-bottom: 2px;
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block title %}Dashboard - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </h1>
                <p class="page-subtitle">Welcome back, {{ current_user.full_name }}! Here's what's happening today.</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-users">{{ stats.total_users }}</h3>
                    <p>Total Active Users</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-students">{{ stats.total_students }}</h3>
                    <p>Enrolled Students</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon info">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-tutors">{{ stats.total_tutors }}</h3>
                    <p>Active Tutors</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-content">
                    <h3 id="todays-classes">{{ stats.todays_classes }}</h3>
                    <p>Today's Classes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="row g-4">
        <!-- Today's Schedule -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-calendar-alt"></i>
                        Today's Schedule
                    </h5>
                </div>
                <div class="card-body">
                    {% if todays_classes %}
                        <div class="schedule-list">
                            {% for class in todays_classes %}
                            <div class="schedule-item">
                                <div class="schedule-time">
                                    <span class="time">{{ class.scheduled_time.strftime('%H:%M') }}</span>
                                    <span class="duration">{{ class.get_duration_display() }}</span>
                                </div>
                                <div class="schedule-content">
                                    <h6>{{ class.subject }}</h6>
                                    <p class="mb-1">
                                        <i class="fas fa-user"></i>
                                        {{ class.tutor.user.full_name }}
                                    </p>
                                    <p class="mb-0">
                                        <i class="fas fa-users"></i>
                                        {% if class.class_type == 'one_on_one' %}
                                            {{ class.primary_student.full_name }}
                                        {% else %}
                                            Group Class ({{ class.get_students()|length }} students)
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="schedule-status">
                                    <span class="badge badge-{{ 'success' if class.status == 'completed' else 'warning' if class.status == 'ongoing' else 'primary' }}">
                                        {{ class.status|title }}
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h6>No Classes Today</h6>
                            <p>There are no scheduled classes for today.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Quick Actions & Alerts -->
        <div class="col-lg-4">
            <!-- Pending Tasks -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-tasks"></i>
                        Pending Tasks
                    </h5>
                </div>
                <div class="card-body">
                    {% if pending_tasks %}
                        {% for task in pending_tasks %}
                        <div class="task-item">
                            <div class="task-icon">
                                <i class="fas fa-{{ 'user-check' if task.type == 'verification' else 'money-bill' if task.type == 'payment' else 'video' }}"></i>
                            </div>
                            <div class="task-content">
                                <h6>{{ task.title }}</h6>
                                <span class="badge badge-{{ task.priority }}">{{ task.count }}</span>
                            </div>
                            <div class="task-action">
                                <a href="{{ task.url }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state small">
                            <i class="fas fa-check-circle"></i>
                            <p>All caught up!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Attendance Alerts -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Attendance Alerts
                    </h5>
                </div>
                <div class="card-body">
                    {% if attendance_alerts %}
                        <div class="alert-list">
                            {% for alert in attendance_alerts %}
                            <div class="alert-item alert-{{ alert.severity }}">
                                <div class="alert-content">
                                    <small class="alert-time">
                                        {% if alert.time %}
                                            {{ alert.time.strftime('%H:%M') }}
                                        {% endif %}
                                    </small>
                                    <p>{{ alert.message }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state small">
                            <i class="fas fa-check-circle"></i>
                            <p>No alerts today!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Department Overview -->
    {% if current_user.role in ['superadmin', 'admin'] %}
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-building"></i>
                        Department Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for dept in stats.departments %}
                        <div class="col-lg-4 col-md-6">
                            <div class="dept-card">
                                <div class="dept-header">
                                    <h6>{{ dept.name }}</h6>
                                </div>
                                <div class="dept-stats">
                                    <div class="dept-stat">
                                        <span class="stat-number">{{ dept.tutors }}</span>
                                        <span class="stat-label">Tutors</span>
                                    </div>
                                    <div class="dept-stat">
                                        <span class="stat-number">{{ dept.students }}</span>
                                        <span class="stat-label">Students</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Charts Row -->
    <div class="row g-4 mt-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line"></i>
                        Attendance Trends (Last 30 Days)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie"></i>
                        Today's Attendance
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="todayAttendanceChart" width="300" height="300"></canvas>
                    <div class="attendance-summary mt-3">
                        <div class="attendance-item">
                            <span class="color-indicator" style="background: #28A745;"></span>
                            <span>Present: {{ stats.todays_attendance.present }}</span>
                        </div>
                        <div class="attendance-item">
                            <span class="color-indicator" style="background: #DC3545;"></span>
                            <span>Absent: {{ stats.todays_attendance.absent }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    padding: 2rem;
}

.schedule-list {
    max-height: 400px;
    overflow-y: auto;
}

.schedule-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    transition: var(--transition);
}

.schedule-item:hover {
    background: var(--bg-light);
}

.schedule-item:last-child {
    border-bottom: none;
}

.schedule-time {
    min-width: 80px;
    text-align: center;
}

.schedule-time .time {
    display: block;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--primary-color);
}

.schedule-time .duration {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.schedule-content {
    flex: 1;
}

.schedule-content h6 {
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.schedule-content p {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.schedule-content i {
    width: 16px;
    margin-right: 0.5rem;
}

.schedule-status {
    min-width: 100px;
    text-align: right;
}

.task-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.task-item:last-child {
    border-bottom: none;
}

.task-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: rgba(241, 161, 80, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-color);
}

.task-content {
    flex: 1;
}

.task-content h6 {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.alert-list {
    max-height: 200px;
    overflow-y: auto;
}

.alert-item {
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    border-left: 4px solid;
}

.alert-item:last-child {
    margin-bottom: 0;
}

.alert-danger {
    background: rgba(220, 53, 69, 0.1);
    border-color: var(--danger-color);
}

.alert-warning {
    background: rgba(255, 193, 7, 0.1);
    border-color: var(--warning-color);
}

.alert-info {
    background: rgba(23, 162, 184, 0.1);
    border-color: var(--info-color);
}

.alert-time {
    color: var(--text-muted);
    font-size: 0.75rem;
}

.alert-content p {
    margin: 0;
    font-size: 0.875rem;
}

.dept-card {
    background: var(--bg-light);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    transition: var(--transition);
}

.dept-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.dept-header h6 {
    margin-bottom: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.dept-stats {
    display: flex;
    justify-content: space-between;
}

.dept-stat {
    text-align: center;
}

.dept-stat .stat-number {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
}

.dept-stat .stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.attendance-summary {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.attendance-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.color-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

.empty-state.small {
    padding: 1rem;
}

.empty-state i {
    font-size: 2rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h6 {
    margin-bottom: 0.5rem;
}

.empty-state p {
    margin: 0;
    font-size: 0.875rem;
}

.badge-high {
    background-color: var(--danger-color);
}

.badge-medium {
    background-color: var(--warning-color);
    color: #856404;
}

.badge-low {
    background-color: var(--info-color);
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .schedule-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .schedule-time {
        min-width: auto;
        text-align: left;
    }
    
    .schedule-status {
        min-width: auto;
        text-align: left;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
});

function initCharts() {
    // Attendance Trends Chart
    fetch('/api/attendance-chart')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        })
        .catch(error => console.error('Error loading attendance chart:', error));

    // Today's Attendance Pie Chart
    const todayCtx = document.getElementById('todayAttendanceChart').getContext('2d');
    new Chart(todayCtx, {
        type: 'doughnut',
        data: {
            labels: ['Present', 'Absent'],
            datasets: [{
                data: [{{ stats.todays_attendance.present }}, {{ stats.todays_attendance.absent }}],
                backgroundColor: ['#28A745', '#DC3545'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function refreshDashboard() {
    // Show loading state
    const refreshBtn = document.querySelector('.header-actions .btn');
    const originalContent = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;

    // Refresh statistics
    fetch('/api/dashboard-stats')
        .then(response => response.json())
        .then(data => {
            // Update stat cards
            document.getElementById('total-users').textContent = data.total_users;
            document.getElementById('total-students').textContent = data.total_students;
            document.getElementById('total-tutors').textContent = data.total_tutors;
            document.getElementById('todays-classes').textContent = data.todays_classes;
            
            // Reload page to refresh other data
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error refreshing dashboard:', error);
            LMS.showAlert('Error refreshing dashboard', 'error');
        })
        .finally(() => {
            refreshBtn.innerHTML = originalContent;
            refreshBtn.disabled = false;
        });
}

// Auto-refresh every 5 minutes
setInterval(refreshDashboard, 300000);
</script>
{% endblock %}